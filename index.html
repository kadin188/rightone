      { name: "Eston", lat: 51.4000, lon: -107.2833 },
      { name: "Fertile Valley", lat: 51.3000, lon: -107.6000 },
      { name: "Fort Qu'Appelle", lat: 50.7667, lon: -103.7667 },
      { name: "Gravelbourg", lat: 49.9833, lon: -105.6000 },
      { name: "Grenfell", lat: 50.3833, lon: -103.1833 },
      { name: "Hanley", lat: 52.3000, lon: -106.3667 },
      { name: "Hague", lat: 52.6667, lon: -106.1333 },
      { name: "Hudson Bay", lat: 52.8500, lon: -102.3500 },
      { name: "Indian Head", lat: 50.5500, lon: -103.6167 },
      { name: "Jansen", lat: 52.7667, lon: -105.4667 },
      { name: "Kelvington", lat: 51.7500, lon: -103.3833 },
      { name: "Kerrobert", lat: 52.6333, lon: -108.2667 },
      { name: "Kindersley", lat: 51.4667, lon: -109.1500 },
      { name: "La Ronge", lat: 55.1000, lon: -105.3000 },
      { name: "Lanigan", lat: 51.9667, lon: -105.1167 },
      { name: "Lemberg", lat: 51.2333, lon: -103.3000 },
      { name: "Lloydminster", lat: 53.2833, lon: -110.0000 },
      { name: "Maidstone", lat: 54.2167, lon: -109.9667 },
      { name: "Maple Creek", lat: 49.9167, lon: -109.4667 },
      { name: "Marcelin", lat: 52.9500, lon: -106.5333 },
      { name: "Martensville", lat: 52.2833, lon: -106.6167 },
      { name: "Meadow Lake", lat: 54.1333, lon: -108.4333 },
      { name: "Melfort", lat: 52.8667, lon: -104.6167 },
      { name: "Melville", lat: 50.9167, lon: -102.8000 },
      { name: "Moosomin", lat: 50.0667, lon: -102.7167 },
      { name: "Moose Jaw", lat: 50.3961, lon: -105.5340 },
      { name: "Nipawin", lat: 53.3667, lon: -104.0000 },
      { name: "North Battleford", lat: 52.7575, lon: -108.2861 },
      { name: "Outlook", lat: 51.5000, lon: -107.0500 },
      { name: "Paddockwood", lat: 53.6167, lon: -105.7333 },
      { name: "Pilot Butte", lat: 50.4667, lon: -104.4667 },
      { name: "Prince Albert", lat: 53.2001, lon: -105.7670 },
      { name: "Radville", lat: 50.0500, lon: -104.6000 },
      { name: "Raymore", lat: 51.7000, lon: -104.2667 },
      { name: "Redvers", lat: 49.9833, lon: -101.9833 },
      { name: "Regina", lat: 50.4452, lon: -104.6189 },
      { name: "Rosetown", lat: 51.5500, lon: -107.9833 },
      { name: "Rosthern", lat: 52.7333, lon: -106.6667 },
      { name: "Saskatoon", lat: 52.1332, lon: -106.6700 },
      { name: "Shaunavon", lat: 49.6500, lon: -108.4167 },
      { name: "Shellbrook", lat: 53.2167, lon: -106.5167 },
      { name: "St. Walburg", lat: 53.0833, lon: -109.7167 },
      { name: "Swift Current", lat: 50.2853, lon: -107.7972 },
      { name: "Tisdale", lat: 52.8500, lon: -104.0500 },
      { name: "Unity", lat: 52.4667, lon: -109.1167 },
      { name: "Watrous", lat: 51.6667, lon: -105.4667 },
      { name: "Weyburn", lat: 49.6611, lon: -103.8522 },
      { name: "Wynyard", lat: 51.7667, lon: -104.1833 },
      { name: "Yorkton", lat: 51.2175, lon: -102.4628 }
    ];

    // First Nations / Reserves
    const reservations = [
      { name: "Ahtahkakoop Cree Nation", lat: 53.0000, lon: -106.5500 },
      { name: "Beardy's & Okemasis Cree Nation", lat: 52.9500, lon: -106.1000 },
      { name: "Big River First Nation", lat: 53.8333, lon: -107.0167 },
      { name: "Cowessess First Nation", lat: 50.4150, lon: -102.2410 },
      { name: "Fond du Lac Dene Nation", lat: 59.6333, lon: -108.0500 },
      { name: "Hatchet Lake First Nation", lat: 58.5833, lon: -105.2500 },
      { name: "Muskeg Lake Cree Nation", lat: 52.866, lon: -106.517 },
      { name: "Mistawasis NÃªhiyawak", lat: 52.900, lon: -106.767 },
      { name: "One Arrow First Nation", lat: 52.733, lon: -106.167 },
      { name: "Onion Lake Cree Nation", lat: 53.7167, lon: -109.5000 },
      { name: "Peepeekisis Cree Nation", lat: 50.7500, lon: -103.4670 },
      { name: "Red Pheasant Cree Nation", lat: 53.1333, lon: -108.5833 },
      { name: "Star Blanket Cree Nation", lat: 50.766, lon: -103.617 },
      { name: "Whitecap Dakota First Nation", lat: 51.923, lon: -106.700 },
      { name: "Little Pine First Nation", lat: 53.1000, lon: -107.5000 },
      { name: "Cumberland House Cree Nation", lat: 53.9500, lon: -102.2000 },
      { name: "Moosomin First Nation", lat: 50.0833, lon: -102.7167 }
    ];

    let allPlaces = [...combinedPlaces, ...reservations];
    let fuse;
    const suggestionBox = document.getElementById("suggestions");

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI/180;
      const dLon = (lon2 - lon1) * Math.PI/180;
      const a = Math.sin(dLat/2)**2 +
                Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
                Math.sin(dLon/2)**2;
      return R * (2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    async function loadOverrides() {
      const overridesCol = collection(db, "overrides");
      const snapshot = await getDocs(overridesCol);
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        allPlaces.push({ name: docSnap.id, obrians: data.obrians, distance: data.distance });
      });
      fuse = new Fuse(allPlaces, { keys:["name"], includeScore:true, threshold:0.4 });
    }

    function findClosest(inputOverride) {
      if (!fuse) { alert("Still loading..."); return; }
      const input = inputOverride || document.getElementById("town").value.trim();
      if (!input) { alert("Enter a town or reserve!"); return; }
      const match = fuse.search(input);
      if (match.length === 0) { document.getElementById("result").innerText="Not found!"; return; }
      const place = match[0].item;
      let closest = null, minDist = Infinity;

      if (place.obrians && place.distance) {
        closest = { name: place.obrians }; minDist = place.distance;
      } else if (place.lat && place.lon) {
        locations.forEach(loc => {
          const d = haversine(place.lat, place.lon, loc.lat, loc.lon);
          if (d < minDist) { minDist = d; closest = loc; }
        });
      }

      const resultDiv = document.getElementById("result");
      resultDiv.innerText = `Closest O'Brians: ${closest.name} (${minDist.toFixed(1)} km from ${place.name})`;
      resultDiv.classList.remove("animate"); void resultDiv.offsetWidth; resultDiv.classList.add("animate");
    }

    async function addOverride() {
      const name = document.getElementById("customName").value.trim();
      const obrians = document.getElementById("customObrians").value.trim();
      const distance = parseFloat(document.getElementById("customDistance").value);
      if (!name || !obrians || isNaN(distance)) { alert("Fill all fields!"); return; }

      await setDoc(doc(db,"overrides",name.toLowerCase()), { obrians, distance });
      allPlaces.push({ name, obrians, distance });
      fuse.setCollection(allPlaces);
      alert("Override saved!");
    }

    loadOverrides().then(()=>{
      const inputBox = document.getElementById("town");
      inputBox.addEventListener("input", ()=>{
        const query = inputBox.value.toLowerCase();
        suggestionBox.innerHTML="";
        if (!query) return;
        const matches = allPlaces.filter(p=>p.name.toLowerCase().startsWith(query));
        matches.forEach(match=>{
          const div=document.createElement("div");
          div.className="suggestion-item";
          div.innerText=match.name;
          div.onclick=()=>{ inputBox.value=match.name; suggestionBox.innerHTML=""; findClosest(match.name); };
          suggestionBox.appendChild(div);
        });
      });
    });

    document.getElementById("searchBtn").addEventListener("click", ()=>findClosest());
    document.getElementById("addBtn").addEventListener("click", ()=>addOverride());
  </script>
</body>
</html>

