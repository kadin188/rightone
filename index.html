<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Closest O'Brians Automotive Finder</title>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>

  <style>
    * { box-sizing: border-box; margin:0; padding:0; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: linear-gradient(to bottom, #1c1c1c, #2c2c2c); color:#fff; min-height:100vh; display:flex; justify-content:center; align-items:center; flex-direction:column; padding:20px; }
    .container { display:flex; flex-direction:column; align-items:center; gap:15px; max-width:700px; width:100%; padding:20px; border-radius:12px; background:rgba(0,0,0,0.5); box-shadow:0 8px 20px rgba(0,0,0,0.6); position:relative; }
    h1 { font-size:2.2rem; color:#f4c542; margin-bottom:10px; text-shadow:2px 2px 6px #000; letter-spacing:1px; }
    h3 { font-weight:normal; font-size:1rem; color:#ccc; margin-bottom:20px; }
    input { padding:12px 20px; font-size:16px; border:none; border-radius:8px; width:280px; margin:5px 0; outline:none; }
    button { padding:12px 20px; font-size:16px; border:none; border-radius:8px; background:linear-gradient(45deg, #007bff, #00c6ff); color:#fff; font-weight:bold; cursor:pointer; transition:all 0.25s ease; box-shadow:0px 4px 6px rgba(0,0,0,0.4); margin-top:5px; }
    button:hover { transform:translateY(-2px); box-shadow:0px 6px 10px rgba(0,0,0,0.45); }
    .suggestions { position:absolute; top:115px; background:white; color:black; width:280px; border-radius:6px; max-height:220px; overflow-y:auto; box-shadow:0 4px 10px rgba(0,0,0,0.3); z-index:999; }
    .suggestion-item { padding:10px; cursor:pointer; }
    .suggestion-item:hover { background:#007bff; color:white; }
    .result { margin-top:30px; font-size:1.1rem; padding:18px 22px; border-radius:10px; background:rgba(255,255,255,0.06); border:2px solid #f4c542; text-align:center; box-shadow:0px 4px 8px rgba(0,0,0,0.45); min-width:320px; word-break:break-word; }
    .result::before { content:"ðŸš— "; }
    .result.animate { animation: fadeIn 0.45s ease-in-out; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(-6px);} to{opacity:1; transform:translateY(0);} }

    /* Car animation */
    #car-animation { display:none; position:relative; height:40px; width:100%; overflow:hidden; margin-bottom:10px; }
    #car { position:absolute; left:-50px; top:0; font-size:32px; transition:left linear; }

    /* Distance meter */
    #distance-meter { display:none; width:100%; background:rgba(255,255,255,0.2); border-radius:8px; margin-top:10px; height:20px; overflow:hidden; }
    #distance-fill { height:100%; width:0%; background:linear-gradient(90deg,#00ff88,#00c6ff); border-radius:8px; transition:width 1s ease; }

    /* Confetti */
    .confetti { position:fixed; width:10px; height:10px; background:red; top:0; z-index:10000; pointer-events:none; opacity:0.8; }

    .override-box { margin-top:18px; padding:14px; border-radius:8px; background:rgba(255,255,255,0.04); width:100%; }
    .override-box h3 { margin-bottom:8px; color:#f4c542; }
    .override-row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .override-row input { flex:1; min-width:160px; }
    .note { font-size:0.85rem; color:#bbb; margin-top:8px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Find Closest O'Brians Automotive</h1>
    <h3>Created by Kadin</h3>

    <!-- Car animation -->
    <div id="car-animation"><div id="car">ðŸš—</div></div>

    <div style="position:relative; width:100%; display:flex; justify-content:center;">
      <input id="town" type="text" placeholder="Enter a town or reservation in SK" autocomplete="off"/>
      <div id="suggestions" class="suggestions" style="display:none;"></div>
    </div>
    <div style="margin-top:8px;">
      <button id="searchBtn">Search</button>
    </div>

    <div id="distance-meter"><div id="distance-fill"></div></div>
    <div class="result" id="result"></div>

    <div class="override-box">
      <h3>Manual Overrides</h3>
      <div class="override-row">
        <input id="customName" type="text" placeholder="Town/Reservation Name" />
        <input id="customObrians" type="text" placeholder="Closest O'Brians Name (e.g., Saskatoon)" />
        <input id="customDistance" type="number" placeholder="Distance (km)" />
        <button id="addBtn">Add Override</button>
      </div>
      <div class="note">Note: overrides are shared via Firebase. Admins can update in the Firestore console if needed.</div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD7a1z9T3Hxicqy7-fTvW71XrunRz_hr-k",
      authDomain: "obrians-finder.firebaseapp.com",
      projectId: "obrians-finder",
      storageBucket: "obrians-finder.firebasestorage.app",
      messagingSenderId: "319977662089",
      appId: "1:319977662089:web:3e2821573e24e555b14858",
      measurementId: "G-LHJX7DG4RS"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const locations = [
      { name: "Saskatoon", lat: 52.1332, lon: -106.6700 },
      { name: "Regina", lat: 50.4452, lon: -104.6189 },
      { name: "Prince Albert", lat: 53.2001, lon: -105.7670 }
    ];

   
    const towns = [
      { name: "North Battleford", lat: 52.7575, lon: -108.2861 },
      { name: "Battleford", lat: 52.7333, lon: -108.3114 },
      { name: "Lloydminster", lat: 53.2833, lon: -110.0000 },
      { name: "Meadow Lake", lat: 54.1333, lon: -108.4333 },
      { name: "Kindersley", lat: 51.4667, lon: -109.1500 },
      { name: "Rosetown", lat: 51.5500, lon: -107.9833 },
      { name: "Biggar", lat: 52.0667, lon: -107.9833 },
      { name: "Humboldt", lat: 52.2000, lon: -105.1333 },
      { name: "Melfort", lat: 52.8667, lon: -104.6170 },
      { name: "Tisdale", lat: 52.8500, lon: -104.0500 },
      { name: "Nipawin", lat: 53.3667, lon: -104.0000 },
      { name: "Wynyard", lat: 51.7667, lon: -104.1833 },
      { name: "Watrous", lat: 51.6667, lon: -105.4667 },
      { name: "Outlook", lat: 51.5000, lon: -107.0500 },
      { name: "Assiniboia", lat: 49.6333, lon: -105.9833 },
      { name: "Weyburn", lat: 49.6611, lon: -103.8522 },
      { name: "Estevan", lat: 49.1392, lon: -102.9860 },
      { name: "Melville", lat: 50.9167, lon: -102.8000 },
      { name: "Foam Lake", lat: 51.6500, lon: -103.5333 },
      { name: "Maple Creek", lat: 49.9167, lon: -109.4667 },
      { name: "Shaunavon", lat: 49.6500, lon: -108.4167 },
      { name: "La Ronge", lat: 55.1000, lon: -105.3000 },
      { name: "Creighton", lat: 54.7667, lon: -101.8833 },
      { name: "Buffalo Narrows", lat: 55.8667, lon: -108.5333 }
         { name: "Canora", lat: 51.6333, lon: -102.4333 },
  { name: "Cabri", lat: 50.6167, lon: -108.4500 },
  { name: "Shellbrook", lat: 53.2167, lon: -106.4000 },
  { name: "Spiritwood", lat: 53.3667, lon: -107.5167 },
  { name: "Sturgis", lat: 51.8500, lon: -102.5333 },
  { name: "Strasbourg", lat: 51.0700, lon: -104.9500 },
  { name: "Sedley", lat: 50.1709, lon: -104.0141 },     // from GeoNames / place-names data :contentReference[oaicite:0]{index=0}
  { name: "Simpson", lat: 51.4500, lon: -105.4500 },
  { name: "Stanley Mission", lat: 55.4200, lon: -104.5500 },
  { name: "Canoe Lake", lat: 55.10, lon: -108.32 },
  { name: "Canoe Narrows", lat: 55.17, lon: -108.15 },
  { name: "Canwood", lat: 53.37, lon: -106.60 },
  { name: "Carlyle", lat: 49.63, lon: -102.27 },
  { name: "Carnduff", lat: 49.17, lon: -101.78 },
  { name: "Chaplin", lat: 50.47, lon: -106.67 },
  { name: "Chitek", lat: 53.78, lon: -107.75 },
  { name: "Gull Lake", lat: 50.1533, lon: -107.5472 },   // approximate from article :contentReference[oaicite:1]{index=1}  
  { name: "Redvers", lat: 49.0567, lon: -102.0539 },     // from Redvers article :contentReference[oaicite:2]{index=2}  
  { name: "Govan", lat: 51.9500, lon: -104.5000 },       // approximate from Govan article :contentReference[oaicite:3]{index=3}  
  { name: "Osler", lat: 52.2500, lon: -106.5167 }  
    const moreCitiesTowns = [
  { name: "Dalmeny", lat: 52.33339, lon: -106.76792 },  
  { name: "Pilot Butte", lat: 50.46678, lon: -104.41778 },  
  { name: "Unity", lat: 52.45014, lon: -109.16816 },  
  { name: "Wadena", lat: 51.94999, lon: -103.80109 },  
  { name: "Warman", lat: 52.31679, lon: -106.56791 },  
  { name: "White City", lat: 50.43338, lon: -104.36778 },  
  { name: "Wilkie", lat: 52.41683, lon: -108.70142 },  
  { name: "Gravelbourg", lat: 49.88336, lon: -106.55122 },  
  { name: "Hudson Bay", lat: 52.85003, lon: -102.38425 },  
  { name: "Oxbow", lat: 49.23335, lon: -102.16760 },  
  { name: "Preeceville", lat: 51.94998, lon: -102.66766 },  
  { name: "Redvers", lat: 49.05670, lon: -102.05390 },  
  { name: "Rosthern", lat: 52.66679, lon: -106.33446 },  
  { name: "Whitewood", lat: 49.98680, lon: -102.32000 },  
  { name: "Aberdeen", lat: 52.41667, lon: -106.91667 },  
  { name: "Alameda", lat: 50.53611, lon: -101.88778 },  
  { name: "Arcola", lat: 49.55167, lon: -102.14500 },  
  { name: "Asquith", lat: 52.46667, lon: -106.96667 },  
  { name: "Balcarres", lat: 50.78333, lon: -103.48333 },  
  { name: "Balgonie", lat: 50.51667, lon: -104.46667 },  
  { name: "Bengough", lat: 50.11667, lon: -105.20000 },  
  { name: "Bienfait", lat: 49.99639, lon: -102.79639 },  
  { name: "Birch Hills", lat: 52.91667, lon: -105.66667 },  
  { name: "Blaine Lake", lat: 53.33333, lon: -106.28333 },  
  { name: "Bruno", lat: 52.93333, lon: -105.36667 },  
  { name: "Cabri", lat: 50.61667, lon: -108.45000 },  
  { name: "Carnduff", lat: 49.16667, lon: -101.78333 },  
  { name: "Chaplin", lat: 50.47000, lon: -106.67000 },  
  { name: "Carlyle", lat: 49.63334, lon: -102.26765 },  
  { name: "Cut Knife", lat: 52.73333, lon: -109.33333 },  
  { name: "Cutknife", lat: 52.7333, lon: -109.3333 },  
  { name: "Eston", lat: 51.21667, lon: -108.63333 },  
  { name: "Foam Lake", lat: 51.65001, lon: -103.53431 },  
  { name: "Indian Head", lat: 50.51667, lon: -103.61667 },  
  { name: "Jasper", lat: 52.0, lon: -106.0 } // approximate placeholder, verify  
];

    ];
       const reservations = [
      { name: "Whitecap Dakota First Nation", lat: 51.923, lon: -106.700 },
      { name: "Muskeg Lake Cree Nation", lat: 52.866, lon: -106.517 },
      { name: "Mistawasis NÃªhiyawak", lat: 52.900, lon: -106.767 },
      { name: "One Arrow First Nation", lat: 52.733, lon: -106.167 },
      { name: "Big River First Nation", lat: 53.833, lon: -107.017 },
      { name: "Cowessess First Nation", lat: 50.415, lon: -102.241 },
      { name: "Star Blanket Cree Nation", lat: 50.766, lon: -103.617 },
      { name: "Onion Lake Cree Nation", lat: 53.7167, lon: -109.5000 },
      { name: "Thunderchild First Nation", lat: 52.7833, lon: -109.1670 },
      { name: "Peepeekisis Cree Nation", lat: 50.7500, lon: -103.4670 },
      { name: "Muscowpetung Saulteaux Nation", lat: 50.8333, lon: -104.4000 },
      { name: "Ahtahkakoop Cree Nation", lat: 53.0000, lon: -106.5500 },
      { name: "Little Pine First Nation", lat: 53.1000, lon: -107.5000 },
      { name: "Cumberland House Cree Nation", lat: 53.9500, lon: -102.2000 },
      { name: "Fond du Lac Dene Nation", lat: 59.6333, lon: -108.0500 },
      { name: "Ochapowace First Nation", lat: 50.2667, lon: -102.7833 },
      { name: "Hatchet Lake First Nation", lat: 58.5833, lon: -105.2500 },
      { name: "Moosomin First Nation", lat: 50.0833, lon: -102.7167 },
      { name: "Red Pheasant Cree Nation", lat: 53.1333, lon: -108.5833 },
      { name: "Beardy's & Okemasis Cree Nation", lat: 52.9500, lon: -106.1000 }
           { name: "Sweetgrass First Nation", lat: 52.7654634, lon: -108.7159253 },  // from place-names data :contentReference[oaicite:5]{index=5}  
  { name: "George Gordon First Nation", lat: 50.484, lon: -103.487 },         // approximate (check with First Nation Profiles)  
  { name: "Piapot First Nation", lat: 49.516, lon: -107.8 },                   // approximate  
  { name: "White Bear First Nation", lat: 50.133, lon: -102.566 },            // approximate  
  { name: "Okanese First Nation", lat: 50.800, lon: -103.9 },                  // approximate  
  { name: "Carry The Kettle First Nation", lat: 50.383, lon: -103.383 },       // approximate  
  { name: "Montreal Lake First Nation", lat: 54.233, lon: -105.0 },            // approximate  
  { name: "Red Earth First Nation", lat: 54.000, lon: -104.7 },                // approximate  
  { name: "Shoal Lake First Nation", lat: 53.900, lon: -105.5 },               // approximate  
  { name: "Sturgeon Lake First Nation", lat: 53.900, lon: -105.383 } 
    ];

    let combinedPlaces = [...towns, ...reservations];
    let fuse = null;
    const suggestionBox = document.getElementById("suggestions");

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    async function loadOverrides() {
      try {
        const overridesCol = collection(db, "overrides");
        const snapshot = await getDocs(overridesCol);
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          combinedPlaces.push({ name: docSnap.id, obrians: data.obrians, distance: data.distance, lat:data.lat||undefined, lon:data.lon||undefined });
        });
      } catch(err){console.error(err);}
      fuse = new Fuse(combinedPlaces,{keys:["name"],includeScore:true,threshold:0.4});
    }

    async function addOverride() {
      const name = document.getElementById("customName").value.trim();
      const obrians = document.getElementById("customObrians").value.trim();
      const distance = parseFloat(document.getElementById("customDistance").value);
      if(!name || !obrians || Number.isNaN(distance)) return alert("Fill all fields!");
      const docId = name.toLowerCase();
      await setDoc(doc(db,"overrides",docId),{obrians,distance});
      combinedPlaces.push({name,obrians,distance}); if(fuse) fuse.setCollection(combinedPlaces);
      document.getElementById("customName").value=""; document.getElementById("customObrians").value=""; document.getElementById("customDistance").value="";
      alert("Override saved.");
    }

    function spawnConfetti() {
      for(let i=0;i<100;i++){
        const c=document.createElement("div");c.className="confetti";
        c.style.left=Math.random()*window.innerWidth+"px";
        c.style.background=`hsl(${Math.random()*360},70%,60%)`;
        document.body.appendChild(c);
        const fall=Math.random()*1500+1000;
        c.animate([{transform:"translateY(0px)"},{transform:`translateY(${window.innerHeight+50}px)`}],{duration:fall,iterations:1});
        setTimeout(()=>c.remove(),fall);
      }
    }

    async function findClosest(inputOverride) {
      if(!fuse) return alert("Loading data...");
      const input=(inputOverride||document.getElementById("town").value).trim();
      if(!input) return alert("Enter a town!");
      const carAnimContainer=document.getElementById("car-animation");
      const car=document.getElementById("car");
      const meter=document.getElementById("distance-meter");
      const fill=document.getElementById("distance-fill");

      carAnimContainer.style.display="block"; car.style.left="-50px";
      meter.style.display="block"; fill.style.width="0%";

      const results=fuse.search(input);
      let place=results.length>0?results[0].item:null;
      if(!place){document.getElementById("result").innerText="Town not found!"; return;}
      let closest=null, minDist=Infinity;
      if(place.obrians && place.distance){closest={name:place.obrians}; minDist=place.distance;}
      else if(place.lat!==undefined && place.lon!==undefined){locations.forEach(loc=>{const d=haversine(place.lat,place.lon,loc.lat,loc.lon); if(d<minDist){minDist=d;closest=loc;}});}
      else{document.getElementById("result").innerText="No distance data"; return;}

      const duration=Math.min(Math.max(minDist*10,800),2500); // speed based on distance
      car.style.transition=`left ${duration}ms linear`;
      fill.style.transition=`width ${duration}ms linear`;
      setTimeout(()=>{car.style.left="calc(100% - 50px)"; fill.style.width="100%"; },10);

      setTimeout(()=>{
        document.getElementById("result").innerText=`Closest O'Brians: ${closest.name} (${minDist.toFixed(1)} km from ${place.name})`;
        spawnConfetti();
        carAnimContainer.style.display="none"; meter.style.display="none";
      },duration);
    }

    await loadOverrides();

    const townInput=document.getElementById("town");
    townInput.addEventListener("input",()=>{
      const query=townInput.value.trim().toLowerCase(); suggestionBox.innerHTML="";
      if(!query){suggestionBox.style.display="none";return;}
      suggestionBox.style.display="block";
      const matches=combinedPlaces.filter(p=>p.name.toLowerCase().startsWith(query)).slice(0,30);
      matches.forEach(match=>{
        const div=document.createElement("div"); div.className="suggestion-item"; div.innerText=match.name;
        div.addEventListener("click",()=>{townInput.value=match.name;suggestionBox.innerHTML="";suggestionBox.style.display="none";findClosest(match.name);});
        suggestionBox.appendChild(div);
      });
    });

    document.getElementById("searchBtn").addEventListener("click",()=>findClosest());
    document.getElementById("addBtn").addEventListener("click",()=>addOverride());
    document.addEventListener("click",(e)=>{if(!document.getElementById("town").contains(e.target)&&!suggestionBox.contains(e.target)){suggestionBox.innerHTML="";suggestionBox.style.display="none";}});
  </script>
</body>
</html>
