<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Closest O'Brians Automotive Finder</title>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
  <!-- Firebase SDKs -->
  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD7a1z9T3Hxicqy7-fTvW71XrunRz_hr-k",
      authDomain: "obrians-finder.firebaseapp.com",
      projectId: "obrians-finder",
      storageBucket: "obrians-finder.firebasestorage.app",
      messagingSenderId: "319977662089",
      appId: "1:319977662089:web:3e2821573e24e555b14858",
      measurementId: "G-LHJX7DG4RS"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db; // Expose for easier use in non-module scripts
  </script>

  <style>
    /* ===== Reset & base ===== */
    * { box-sizing: border-box; margin:0; padding:0; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: linear-gradient(to bottom, #1c1c1c, #2c2c2c); color:#fff; min-height:100vh; display:flex; justify-content:center; align-items:center; flex-direction:column; padding:20px; }
    .container { display:flex; flex-direction:column; align-items:center; gap:15px; max-width:600px; width:100%; padding:20px; border-radius:12px; background:rgba(0,0,0,0.5); box-shadow:0 8px 20px rgba(0,0,0,0.6); position:relative; }
    h1 { font-size:2.5rem; color:#f4c542; margin-bottom:10px; text-shadow:2px 2px 6px #000; letter-spacing:1px; }
    h3 { font-weight:normal; font-size:1rem; color:#ccc; margin-bottom:20px; }
    input { padding:12px 20px; font-size:16px; border:none; border-radius:8px; width:250px; margin:5px 0; outline:none; }
    button { padding:12px 25px; font-size:16px; border:none; border-radius:8px; background:linear-gradient(45deg, #007bff, #00c6ff); color:#fff; font-weight:bold; cursor:pointer; transition:all 0.3s ease; box-shadow:0px 4px 6px rgba(0,0,0,0.4); margin-top:5px; }
    button:hover { transform:translateY(-2px); box-shadow:0px 6px 10px rgba(0,0,0,0.5); }
    .suggestions { position:absolute; top:115px; background:white; color:black; width:250px; border-radius:6px; max-height:200px; overflow-y:auto; box-shadow:0 4px 10px rgba(0,0,0,0.3); z-index:999; }
    .suggestion-item { padding:10px; cursor:pointer; }
    .suggestion-item:hover { background:#007bff; color:white; }
    .result { margin-top:30px; font-size:1.5rem; padding:20px 30px; border-radius:10px; background:rgba(255,255,255,0.1); border:2px solid #f4c542; text-align:center; box-shadow:0px 4px 8px rgba(0,0,0,0.5); min-width:300px; }
    .result::before { content:"ðŸš— "; }
    .result.animate { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from { opacity:0; transform:translateX(-10px);} to{opacity:1; transform:translateX(0);} }
    .override-box { margin-top:25px; padding:15px; border-radius:8px; background:rgba(255,255,255,0.1); width:100%; }
    .override-box h3 { margin-bottom:10px; color:#f4c542; }
    .override-box input { width:100%; margin-bottom:8px; border-radius:6px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Find Closest O'Brians Automotive</h1>
    <h3>Created by Kadin</h3>

    <div style="position:relative;">
      <input id="town" type="text" placeholder="Enter a town or reservation in SK" autocomplete="off"/>
      <div id="suggestions" class="suggestions"></div>
      <button onclick="findClosest()">Search</button>
    </div>

    <div class="result" id="result"></div>

    <div class="override-box">
      <h3>Manual Overrides</h3>
      <input id="customName" type="text" placeholder="Town/Reservation Name" />
      <input id="customObrians" type="text" placeholder="Closest O'Brians Name (e.g., Saskatoon)" />
      <input id="customDistance" type="number" placeholder="Distance (km)" />
      <button onclick="addOverride()">Add Override</button>
    </div>
  </div>

  <script type="module">
    import { db } from "./"; // Using the Firebase db initialized above
    import { collection, getDocs, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // Locations & towns
    const locations = [
      { name: "Saskatoon", lat: 52.1332, lon: -106.6700 },
      { name: "Regina", lat: 50.4452, lon: -104.6189 },
      { name: "Prince Albert", lat: 53.2001, lon: -105.7670 },
      { name: "Moose Jaw", lat: 50.3961, lon: -105.5340 },
      { name: "Yorkton", lat: 51.2175, lon: -102.4628 },
      { name: "Swift Current", lat: 50.2853, lon: -107.7972 }
    ];

    const towns = [
      { name: "North Battleford", lat: 52.7575, lon: -108.2861 },
      { name: "Battleford", lat: 52.7333, lon: -108.3114 },
      { name: "Lloydminster", lat: 53.2833, lon: -110.0000 },
      { name: "Meadow Lake", lat: 54.1333, lon: -108.4333 },
      { name: "Kindersley", lat: 51.4667, lon: -109.1500 },
      { name: "Rosetown", lat: 51.5500, lon: -107.9833 },
      { name: "Biggar", lat: 52.0667, lon: -107.9833 },
      { name: "Humboldt", lat: 52.2000, lon: -105.1333 },
      { name: "Melfort", lat: 52.8667, lon: -104.6170 },
      { name: "Tisdale", lat: 52.8500, lon: -104.0500 },
      { name: "Nipawin", lat: 53.3667, lon: -104.0000 },
      { name: "Wynyard", lat: 51.7667, lon: -104.1833 },
      { name: "Watrous", lat: 51.6667, lon: -105.4667 },
      { name: "Outlook", lat: 51.5000, lon: -107.0500 },
      { name: "Assiniboia", lat: 49.6333, lon: -105.9833 },
      { name: "Weyburn", lat: 49.6611, lon: -103.8522 },
      { name: "Estevan", lat: 49.1392, lon: -102.9860 },
      { name: "Melville", lat: 50.9167, lon: -102.8000 },
      { name: "Foam Lake", lat: 51.6500, lon: -103.5333 },
      { name: "Maple Creek", lat: 49.9167, lon: -109.4667 },
      { name: "Shaunavon", lat: 49.6500, lon: -108.4167 },
      { name: "La Ronge", lat: 55.1000, lon: -105.3000 },
      { name: "Creighton", lat: 54.7667, lon: -101.8833 },
      { name: "Buffalo Narrows", lat: 55.8667, lon: -108.5333 }
    ];

    const reservations = [
      { name: "Whitecap Dakota First Nation", lat: 51.923, lon: -106.700 },
      { name: "Muskeg Lake Cree Nation", lat: 52.866, lon: -106.517 },
      { name: "Mistawasis NÃªhiyawak", lat: 52.900, lon: -106.767 },
      { name: "One Arrow First Nation", lat: 52.733, lon: -106.167 },
      { name: "Big River First Nation", lat: 53.833, lon: -107.017 },
      { name: "Cowessess First Nation", lat: 50.415, lon: -102.241 },
      { name: "Star Blanket Cree Nation", lat: 50.766, lon: -103.617 },
      { name: "Onion Lake Cree Nation", lat: 53.7167, lon: -109.5000 },
      { name: "Thunderchild First Nation", lat: 52.7833, lon: -109.1670 },
      { name: "Peepeekisis Cree Nation", lat: 50.7500, lon: -103.4670 },
      { name: "Muscowpetung Saulteaux Nation", lat: 50.8333, lon: -104.4000 },
      { name: "Ahtahkakoop Cree Nation", lat: 53.0000, lon: -106.5500 },
      { name: "Little Pine First Nation", lat: 53.1000, lon: -107.5000 },
      { name: "Cumberland House Cree Nation", lat: 53.9500, lon: -102.2000 },
      { name: "Fond du Lac Dene Nation", lat: 59.6333, lon: -108.0500 },
      { name: "Ochapowace First Nation", lat: 50.2667, lon: -102.7833 },
      { name: "Hatchet Lake First Nation", lat: 58.5833, lon: -105.2500 },
      { name: "Moosomin First Nation", lat: 50.0833, lon: -102.7167 },
      { name: "Red Pheasant Cree Nation", lat: 53.1333, lon: -108.5833 },
      { name: "Beardy's & Okemasis Cree Nation", lat: 52.9500, lon: -106.1000 }
    ];

    let combinedPlaces = [...towns, ...reservations];
    let fuse;
    const suggestionBox = document.getElementById("suggestions");

    // Function to calculate distance
    function haversine(lat1, lon1, lat2, lon2) {
      const R=6371;
      const dLat=(lat2-lat1)*Math.PI/180;
      const dLon=(lon2-lon1)*Math.PI/180;
      const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
      return R*(2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    // Load manual overrides from Firestore
    async function loadOverrides() {
      const overridesCol = collection(db, "overrides");
      const snapshot = await getDocs(overridesCol);
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        combinedPlaces.push({ name: docSnap.id, lat: data.lat, lon: data.lon, obrians: data.obrians, distance: data.distance });
      });
      fuse = new Fuse(combinedPlaces, { keys:["name"], includeScore:true, threshold:0.4 });
    }

    // Initialize autocomplete search after overrides loaded
    loadOverrides().then(() => {
      const inputBox = document.getElementById("town");
      inputBox.addEventListener("input", ()=>{
        const query = inputBox.value.toLowerCase();
        suggestionBox.innerHTML="";
        if(!query) return;
        const matches = combinedPlaces.filter(p => p.name.toLowerCase().startsWith(query));
        matches.forEach(match => {
          const div = document.createElement("div");
          div.className = "suggestion-item"; div.innerText = match.name;
          div.onclick = () => { inputBox.value = match.name; suggestionBox.innerHTML = ""; findClosest(match.name); };
          suggestionBox.appendChild(div);
        });
      });
    });

    // Add manual override
    async function addOverride() {
      const name = document.getElementById("customName").value.trim();
      const obrians = document.getElementById("customObrians").value.trim();
      const distance = parseFloat(document.getElementById("customDistance").value);
      if(!name || !obrians || isNaN(distance)){ alert("Please fill in all fields correctly!"); return; }

      const docRef = doc(db, "overrides", name.toLowerCase());
      await setDoc(docRef, { obrians, distance });

      // Add to combinedPlaces for immediate search update
      combinedPlaces.push({ name, obrians, distance });
      fuse.setCollection(combinedPlaces);

      document.getElementById("customName").value = "";
      document.getElementById("customObrians").value = "";
      document.getElementById("customDistance").value = "";
      alert("Manual override saved!");
    }

    // Find closest O'Brians
    function findClosest(inputOverride){
      if(!fuse){ alert("Still loading overrides, please wait a moment."); return; }
      const input = inputOverride || document.getElementById("town").value.trim();
      if(!input){ alert("Please enter a town or reservation!"); return; }
      const match = fuse.search(input);
      if(match.length===0){ document.getElementById("result").innerText = "Town or reservation not found!"; return; }
      const place = match[0].item;

      let closest=null, minDist=Infinity;
      locations.forEach(loc => {
        if(place.lat && place.lon){
          const d=haversine(place.lat, place.lon, loc.lat, loc.lon);
          if(d<minDist){ minDist=d; closest=loc; }
        } else if(place.obrians && place.distance){
          closest = {name: place.obrians};
          minDist = place.distance;
        }
      });

      const resultDiv = document.getElementById("result");
      resultDiv.innerText = `Closest O'Brians: ${closest.name} (${minDist.toFixed(1)} km from ${place.name})`;
      resultDiv.classList.remove("animate"); void resultDiv.offsetWidth; resultDiv.classList.add("animate");
    }
  </script>
</body>
</html>

